<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cr√©er mon CV ‚Äî CVMeilleur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="cv-container">

  <!-- üîê PROTECTION CONNEXION -->
  <script>
    if (localStorage.getItem("connected") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <!-- √âTAPES -->
  <div class="cv-steps">
    <div class="cv-step active">Coordonn√©es</div>
    <div class="cv-step">Exp√©rience</div>
    <div class="cv-step">Formation</div>
    <div class="cv-step">Comp√©tences</div>
    <div class="cv-step">R√©sum√©</div>
    <div class="cv-step">Finaliser</div>
  </div>

  <div class="cv-builder">

    <!-- ================= FORM ================= -->
    <div class="cv-form">

      <!-- STEP 0 -->
      <div class="form-step active">
        <h2>Coordonn√©es</h2>
        <input id="nameInput" placeholder="Nom complet" oninput="updateAll()">
        <input id="jobInput" placeholder="Profession (ex: Analyste de donn√©es)" oninput="updateAll()">
        <input id="emailInput" placeholder="Email" oninput="updateAll()">
        <input id="phoneInput" placeholder="T√©l√©phone (ex: +1 514 123 4567)" oninput="updateAll()" onblur="validatePhoneFinal()">
        <small id="phoneError" class="error-msg">Num√©ro invalide</small>
      </div>

      <!-- STEP 1 -->
      <div class="form-step">
        <h2>Exp√©rience</h2>

        <div id="experienceList">
          <div class="exp-block">
            <input placeholder="Entreprise (ex: Hydro-Qu√©bec)" oninput="updateAll()">
            <input placeholder="Poste (ex: Analyste de donn√©es)" oninput="updateAll()">

            <div class="row">
              <input class="year-input start-year" inputmode="numeric" maxlength="4"
                     placeholder="Ann√©e d√©but" oninput="updateAll()">
              <input class="year-input end-year" inputmode="numeric" maxlength="4"
                     placeholder="Ann√©e fin" oninput="updateAll()">
            </div>

            <small class="error-msg year-error">Ann√©es invalides (AAAA, d√©but ‚â§ fin)</small>

            <textarea placeholder="Description (missions, r√©sultats‚Ä¶)" oninput="updateAll()"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button class="add-btn" onclick="addExperience()">+ Ajouter</button>
          <button class="remove-btn" id="removeExpBtn" onclick="removeExperience()">Supprimer</button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-step">
        <h2>Formation</h2>

        <div id="educationList">
          <div class="edu-block">
            <input placeholder="Dipl√¥me (ex: Baccalaur√©at en informatique)" oninput="updateAll()">
            <input placeholder="√âtablissement (ex: Universit√© de Montr√©al)" oninput="updateAll()">

            <div class="row">
              <input class="year-input start-year" inputmode="numeric" maxlength="4"
                     placeholder="Ann√©e d√©but" oninput="updateAll()">
              <input class="year-input end-year" inputmode="numeric" maxlength="4"
                     placeholder="Ann√©e fin" oninput="updateAll()">
            </div>

            <small class="error-msg year-error">Ann√©es invalides (AAAA, d√©but ‚â§ fin)</small>

            <textarea placeholder="Cours, projets, distinctions‚Ä¶" oninput="updateAll()"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button class="add-btn" onclick="addEducation()">+ Ajouter</button>
          <button class="remove-btn" id="removeEduBtn" onclick="removeEducation()">Supprimer</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="form-step">
        <h2>Comp√©tences</h2>
        <textarea id="skillsInput" placeholder="Python, SQL, Power BI‚Ä¶" oninput="updateAll()"></textarea>
      </div>

      <!-- STEP 4 -->
      <div class="form-step">
        <h2>R√©sum√©</h2>
        <textarea id="summaryInput" placeholder="R√©sum√© professionnel" oninput="updateAll()"></textarea>
      </div>

      <!-- STEP 5 -->
      <div class="form-step">
        <h2>Finaliser</h2>
        <button class="btn-primary">T√©l√©charger le CV</button>
      </div>

      <!-- NAV -->
      <div class="form-nav">
        <button id="prevBtn" class="btn-outline" onclick="prevStep()">Retour</button>
        <button class="btn-primary" onclick="nextStep()">Suivant</button>
      </div>

    </div>

    <!-- ================= PREVIEW ================= -->
    <div class="cv-preview">
      <h3>Aper√ßu du CV</h3>
      <div class="preview-box" id="livePreview"></div>
    </div>

  </div>
</div>

<script>
let currentStep = 0;
const steps = document.querySelectorAll(".form-step");
const indicators = document.querySelectorAll(".cv-step");

function showStep(i){
  steps.forEach((s,n)=>s.classList.toggle("active", n === i));
  indicators.forEach((s,n)=>s.classList.toggle("active", n <= i));

  const prev = document.getElementById("prevBtn");
  prev.disabled = i === 0;
  prev.style.opacity = i === 0 ? "0.4" : "1";
}

function nextStep(){ if(currentStep < steps.length-1){ currentStep++; showStep(currentStep); } }
function prevStep(){ if(currentStep > 0){ currentStep--; showStep(currentStep); } }

function validatePhoneFinal(){
  const ok=/^\+?\d{6,}$/.test(phoneInput.value);
  phoneError.style.display = phoneInput.value && !ok ? "block" : "none";
}

/* ---------- BLOCS ---------- */
function addExperience(){ cloneBlock("experienceList","exp-block"); }
function removeExperience(){ removeBlock("experienceList"); }
function addEducation(){ cloneBlock("educationList","edu-block"); }
function removeEducation(){ removeBlock("educationList"); }

function cloneBlock(id,cls){
  const b=document.querySelector("."+cls).cloneNode(true);
  b.querySelectorAll("input,textarea").forEach(e=>e.value="");
  document.getElementById(id).appendChild(b);
  updateButtons(); updateAll();
}

function removeBlock(id){
  const l=document.getElementById(id);
  if(l.children.length>1) l.removeChild(l.lastElementChild);
  updateButtons(); updateAll();
}

function updateButtons(){
  removeExpBtn.style.display = experienceList.children.length>1 ? "inline" : "none";
  removeEduBtn.style.display = educationList.children.length>1 ? "inline" : "none";
}

/* ---------- VALIDATION ANN√âES ---------- */
function isYearValid(start, end){
  if(!start && !end) return true;
  if(!/^\d{4}$/.test(start) || !/^\d{4}$/.test(end)) return false;
  return parseInt(start) <= parseInt(end);
}

/* ---------- PREVIEW ---------- */
function updateAll(){
  let h = `
    <h2>${nameInput.value || "Votre nom complet"}</h2>
    <h4>${jobInput.value || "Votre profession"}</h4>
    <p>${emailInput.value || ""}</p>
    <p>${phoneInput.value || ""}</p>
    <hr>
  `;

  document.querySelectorAll(".exp-block").forEach(b=>{
    const i=b.querySelectorAll("input,textarea");
    const ok=isYearValid(i[2].value,i[3].value);
    b.querySelector(".year-error").style.display = ok ? "none" : "block";
    if(ok && i[0].value){
      h+=`<p><strong>${i[1].value}</strong> ‚Äî ${i[0].value} (${i[2].value}‚Äì${i[3].value})<br>${i[4].value}</p>`;
    }
  });

  document.querySelectorAll(".edu-block").forEach(b=>{
    const i=b.querySelectorAll("input,textarea");
    const ok=isYearValid(i[2].value,i[3].value);
    b.querySelector(".year-error").style.display = ok ? "none" : "block";
    if(ok && i[0].value){
      h+=`<p><strong>${i[0].value}</strong>, ${i[1].value} (${i[2].value}‚Äì${i[3].value})</p>`;
    }
  });

  if(skillsInput.value) h+=`<p><strong>Comp√©tences :</strong> ${skillsInput.value}</p>`;
  if(summaryInput.value) h+=`<p><strong>R√©sum√© :</strong> ${summaryInput.value}</p>`;

  livePreview.innerHTML = h;
}

/* AUTO PROFIL */
function fillFromProfile(){
  try{
    const p=JSON.parse(localStorage.getItem("userProfile")||"{}");
    if(p.name) nameInput.value=p.name;
    if(p.email) emailInput.value=p.email;
    if(p.phone) phoneInput.value=p.phone;
  }catch(e){}
}

document.addEventListener("DOMContentLoaded",()=>{
  updateButtons();
  showStep(0);
  fillFromProfile();
  updateAll();
});
</script>

</body>
</html>